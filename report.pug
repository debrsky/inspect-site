doctype html
html(lang="ru")
  head
    meta(charset="UTF-8")
    meta(name="viewport", content="width=device-width, initial-scale=1.0")
    title Проверка сайта dvggtk.ru
    style.
      summary {
        cursor: pointer;
      }

  body
    header
      - const domain = new URL(startUrl).host;
      h1 Проверка сайта #[a(href=startUrl)= domain]
      - const timestamp = new Date();
      p Дата и время проверки #[time(datetime=timestamp.toISOString())=timestamp.toLocaleString()]
      div
        button#inspect Начать новую проверку

    main
      section
        h2 Битые ссылки (#{brokenLinks.length})
        ol
          each row in brokenLinks
            li
              div
                p
                  a(href=row.url)= decodeURIComponent(row.url)
                details
                  summary Страницы, где найдена ссылка (#{row.linksFrom.length})
                  ul
                    each linkFrom in row.linksFrom
                      li
                        a(href=linkFrom)= decodeURIComponent(linkFrom)

      section
        h2 Ссылки на test-dv.ru (#{testLinks.length})
        ol
          each row in testLinks
            li
              div
                p
                  a(href=row.url)= decodeURIComponent(row.url)
                details
                  summary Страницы, где найдена ссылка (#{row.linksFrom.length})
                  ul
                    each linkFrom in row.linksFrom
                      li
                        a(href=linkFrom)= decodeURIComponent(linkFrom)

    footer ∎

    script.
      const sse = new EventSource('/events');
      sse.addEventListener('message', (event) => {
        console.log('data', event.data);
      });

      sse.addEventListener('finish', (event) => {
        window.location.reload();
      });

      const inspectBtn = document.getElementById('inspect');
      inspectBtn.addEventListener('click', async (event) => {
        try {
        const res = await fetch('/inspect?start=1');
        if (!res.ok) {
          console.log({res});
        } else {
          const url = '/log';
          const windowName = 'Лог проверки сайта';
          const windowFeatures = 'width=800,height=600,toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes';

          const newWindow = window.open(url, windowName, windowFeatures);
        }

        } catch (err) {
          console.log(err);
        }
      })
